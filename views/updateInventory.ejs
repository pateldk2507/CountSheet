<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
  <h2>Update Inventory</h2>

  <!-- Location Selection -->
  <div class="mb-3">
    <label for="locationSelect" class="form-label">Select Location</label>
    <select class="form-select" id="locationSelect">
      <option value="1101">WH1</option>
      <option value="1143">Pulled</option>
      <option value="955">Truck Esko</option>
      <option value="956">Truck Gerry</option>
      <option value="957">Truck David D</option>
      <option value="958">Truck Lawrance</option>
      <option value="959">Truck Chris OG</option>
      <option value="1099">Truck Troy</option>
      <option value="1100">Truck Geoff</option>
    </select>
  </div>

  <!-- Buttons -->
  <div class="mb-3">
    <button class="btn btn-primary me-2" id="generateJsonBtn">Generate JSON</button>
    <button class="btn btn-success" id="applyChangesBtn">Apply Changes</button>
  </div>

  <div id="status" class="mt-3"></div>
</div>

<script>
  const statusDiv = document.getElementById('status');

  // Generate JSON
  document.getElementById('generateJsonBtn').addEventListener('click', async () => {
    const location = document.getElementById('locationSelect').value;
    if (!location) return alert("Please select a location");

    try {
      const res = await fetch(`/update/json?location=${location}`);
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `location_${location}.json`;
      a.click();
      window.URL.revokeObjectURL(url);

      statusDiv.innerHTML = `<div class="alert alert-success">JSON downloaded successfully!</div>`;
    } catch (err) {
      console.error(err);
      statusDiv.innerHTML = `<div class="alert alert-danger">Error generating JSON</div>`;
    }
  });

  // Apply Changes
  document.getElementById('applyChangesBtn').addEventListener('click', async () => {
    const location = document.getElementById('locationSelect').value;
    if (!location) return alert("Please select a location");

    statusDiv.innerHTML = `<div class="alert alert-info">Applying changes, please wait...</div>`;

    try {
      const res = await fetch(`/update/apply`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ location })
      });

      const data = await res.json();
      if (res.ok) {
        // Download log file
        const logRes = await fetch(data.log_file);
        const logBlob = await logRes.blob();
        const logUrl = window.URL.createObjectURL(logBlob);
        const a = document.createElement('a');
        a.href = logUrl;
        a.download = `update_log_${location}.txt`;
        a.click();
        window.URL.revokeObjectURL(logUrl);

        statusDiv.innerHTML = `<div class="alert alert-success">Inventory update completed! Log downloaded.</div>`;
      } else {
        statusDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to apply changes'}</div>`;
      }
    } catch (err) {
      console.error(err);
    //   statusDiv.innerHTML = `<div class="alert alert-danger">Error applying changes: ${err.message}</div>`;
    }
  });
</script>
</body>
</html>
